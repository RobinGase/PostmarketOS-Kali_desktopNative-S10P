# Preflight Runbook (Non-Destructive First)

## Purpose
Operator procedure for fail-closed validation before any controlled flash eligibility is documented.

## Prerequisites
- `bash` and `sha256sum` available in operator shell.
- `artifacts/` directory exists and is writable.
- Manifest file exists and includes valid `sha256` entries.
- Off-mode only: one USB-attached target device visible to `adb`, no other attached Android devices.
- Optional for off-mode: set `PRECHECK_ADB_BIN` when `adb` is not on `PATH`.

## Gate Order
1. Identity and unlock state
   - Confirm target lane: `SM-G975F` / `beyond2lte` / Exynos.
   - Confirm required approval ID is present.
2. vbmeta and rollback gate
   - Confirm manifest integrity and target metadata alignment.
   - Confirm rollback plan and rehearsal evidence availability.
3. Non-destructive checks
   - Run strict simulation preflight and collect artifacts.
   - Record any readiness blockers without modifying partitions.
4. Controlled flash eligibility (documentation only)
   - Eligible only if all gates pass and rollback rehearsal evidence exists.
   - This runbook does not authorize or perform flashing.

## Abort Criteria
- Missing approval ID.
- Target identity mismatch (model/codename/SoC).
- Manifest parse failure or checksum mismatch.
- Metadata indicates Snapdragon/QCOM for S10+ Exynos lane.
- Missing rollback rehearsal evidence.

## Log Collection Checklist
- Timestamped preflight log path under run scope (`artifacts/runs/<RUN_ID>/`) or explicit `PRECHECK_ARTIFACT_DIR`.
- Machine-readable evidence JSON path under run scope (`artifacts/runs/<RUN_ID>/`) or explicit `PRECHECK_ARTIFACT_DIR`.
- Command invocation with arguments (excluding secrets).
- Manifest path and metadata values observed.
- Pass/fail decision with exit code.
- Reference to rollback rehearsal evidence location.

## Evidence JSON Fields
- `schema_version`
- `tool_version`
- `timestamp`
- `approval_id`
- `simulate`
- `target_model`, `target_codename`, `target_soc`
- `target_serial_requested`
- `selected_serial` (set for off mode)
- `manifest_path`
- `manifest_entry_count`
- `manifest_metadata.model`, `manifest_metadata.codename`, `manifest_metadata.soc`
- `result` (`PASS` or `FAIL`)
- `exit_code`
- `failure_stage` and `failure_reason` (`failure_reason` empty on pass)
- `log_path`
- Usage failures must still emit minimal FAIL evidence JSON with `failure_stage=usage`.

## Live Profile Workflow
1. Copy `profiles/live_s10_exynos.env.example` to an operator-only env file.
2. Fill required `KEY=VALUE` pairs: `TARGET_MODEL`, `TARGET_CODENAME`, `TARGET_SOC`, `MANIFEST`, `APPROVAL_ID`.
3. Optional keys: `TARGET_SERIAL`, `SIMULATE`, `PRECHECK_ADB_BIN`.
4. Run `bash scripts/run_preflight_live.sh --env-file <your_env_file>`.
5. Wrapper denies unsupported keys, unsafe substitutions, malformed entries, and missing required fields.

## Artifact Retention
- Retain both preflight log and evidence JSON for strict and off runs inside each run directory.
- Keep artifacts for all failed preflight attempts to preserve fail-closed evidence.
- Prune stale artifacts (including old run directories) with `bash scripts/prune_artifacts.sh --dry-run` before real deletion.

## Pipeline Bundle
- `bash scripts/run_pipeline.sh` now runs syntax checks and tests for:
  - preflight scripts
  - live wrapper scripts
  - artifact pruning scripts
- Pipeline enforces a single-run lock (`flock` preferred, lock-directory fallback) to prevent concurrent runs.
- On success, it emits under `artifacts/runs/<RUN_ID>/`:
  - `pipeline_bundle_<UTCSTAMP>.json`
  - `pipeline_bundle_<UTCSTAMP>.sha256`
- Bundle content includes:
  - `schema_version`
  - `tool_version`
  - UTC `timestamp`
  - `run_id` and `run_dir`
  - `pipeline_result`
  - `test_summary`
  - evidence refs to preflight log and JSON generated by the same run
- SHA file signs the bundle plus referenced evidence files.
- Pipeline auto-runs prune on success with default retention; set `PIPELINE_SKIP_PRUNE=1` to skip.

## Operator Commands
- Strict simulation (no live device checks):
  `bash scripts/run_preflight.sh --target-model SM-G975F --target-codename beyond2lte --target-soc exynos --manifest fixtures/manifests/example_manifest.txt --approval-id APR-100 --simulate strict`
- Off simulation (read-only live checks + identity gates):
  `bash scripts/run_preflight.sh --target-model SM-G975F --target-codename beyond2lte --target-soc exynos --target-serial R58M12345AB --manifest fixtures/manifests/example_manifest.txt --approval-id APR-101 --simulate off`
- Off simulation with explicit adb binary:
  `PRECHECK_ADB_BIN=/opt/android/platform-tools/adb bash scripts/run_preflight.sh --target-model SM-G975F --target-codename beyond2lte --target-soc exynos --manifest fixtures/manifests/example_manifest.txt --approval-id APR-102 --simulate off`
- Live profile runner:
  `bash scripts/run_preflight_live.sh --env-file profiles/live_s10_exynos.env.example`

## Testing-Phase Ready Evidence
- Latest strict run exits `0` and logs `preflight_result=PASS`.
- Latest off run exits `0` and logs selected serial + `ro.product.model`/`ro.product.device`/`ro.hardware`.
- Off run confirms exactly one connected device and `adb get-state=device`.
- No Snapdragon/QCOM indicators in target tuple, manifest metadata, or connected-device hardware.
- Artifact log file retained under `artifacts/preflight_*.log` and evidence JSON under `artifacts/preflight_*.json` for both strict and off runs.
